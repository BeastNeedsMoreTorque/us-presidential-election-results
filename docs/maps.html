<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora">
    <style>
        body {
            font-family: 'Lora', serif;
        }
        
        .nation,
        .states,
        .counties {
            fill: none;
            stroke: #000000;
            stroke-linejoin: round;
            stroke-linecap: round;
        }
        
        .background {
            fill: #f5f5f5;
            fill-opacity: 0.5;
        }
        
        .tooltip {
            top: 100px;
            left: 100px;
            -moz-border-radius: 5px;
            border-radius: 5px;
            /*border: 2px solid #000;*/
            background: #333;
            opacity: .9;
            color: white;
            padding: 10px;
            min-width: 375px;
            min-width: 36.75vmin;
            font-size: 2.25vmin;
            line-height: 24pt;
            font-family: 'Lora', serif;
            font-weight: lighter;
            visibility: visible;
        }
        
        .tooltip.right::before {
            content: '';
            display: block;
            width: 0;
            height: 0;
            position: absolute;
            opacity: .9;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 8px solid #333;
            right: -8px;
            top: 35px;
            /* arbitrarily set */
        }
        
        .tooltip.left::before {
            content: '';
            display: block;
            width: 0;
            height: 0;
            position: absolute;
            opacity: .9;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            left: -8px;
            border-right: 8px solid #333;
            top: 35px;
            /* arbitrarily set */
        }
        /* SVG Scaling */
        /*body,*/
        /*svg {*/
        /*    height: 100%;*/
        /*    margin: 0;*/
        /*    width: 100%;*/
        /*    float: left;*/
        /*}*/
        
        .scaling-svg-container {
            position: relative;
            height: 0;
            width: 100%;
            padding: 0
        }
        
        .scaling-svg {
            position: absolute;
            height: 99%;
            width: 100%;
            left: 0;
            top: 0
        }
    </style>

</head>


<body>

    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-md-12">
                <div class="page-header">
                    <h2>3,115 Americas <small>Exploring U.S. County Health During the 2016 Presidential Election</small></h2>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-4 col-md-4">
                <div class="form-group">
                    <label for="dimensions" class="col-form-label">Factor </label>
                    <select class="form-control" id="dimensions"></select>
                </div>
            </div>
            <div class="col-xs-8 col-md-8"></div>
        </div>
        <div class="row" id="canvas">
            <div class="col-md-9 col-xs-9">
                <div class="scaling-svg-container">
                    <svg></svg>
                </div>
            </div>
            <div class="col-md-3 col-xs-3">
                <div id="textDescription" style="height:250px;">
                    <h3></h3>
                    <p></p>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-md-12" id="source">
                <footnote></footnote>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-md-12">
                <footer>
                    <span>Analysis and visualizations by Scott Gregoire, Nick Heitzman, and Tony McGovern</span>
                </footer>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.0.1/spin.min.js" type="text/javascript"></script>
    <script src="https://d3js.org/d3.v4.min.js" type="text/javascript"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/topojson-client@3" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.11.0/d3-legend.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" type="text/javascript"></script>
    <script defer type="text/javascript">
        "use strict";

        // default view for map
        let measure = 'uninsured';

        // define data and its attributes
        const cols = {
            "pcprate": {
                "label": "PCP Rate",
                "type": "number",
                "format": ",.0f",
                "title": "Primary care physicians",
                "url": "http://www.countyhealthrankings.org/measure/primary-care-physicians",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Primary Care Physicians is the ratio of the population to total primary care physicians. Primary care physicians include non-federal, practicing physicians (M.D.'s and D.O.'s) under age 75 specializing in general practice medicine, family medicine, internal medicine, and pediatrics."
            },
            "population": {
                "label": "Population",
                "type": "number",
                "format": ".2s",
                "title": "Population",
                "url": "https://www2.census.gov/programs-surveys/popest/datasets/2010-2016/counties/totals/",
                "source": "United States Census",
                "description": "Population estimates totals provided by the Census Bureau and are as of 2016"
            },
            "pollution": {
                "label": "Average Daily PM2.5",
                "type": "number",
                "format": ",.1f",
                "title": "Air pollution-particulate matter",
                "url": "http://www.countyhealthrankings.org/measure/air-pollution-particulate-matter",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Particulate Matter is the average daily density of fine particulate matter in micrograms per cubic meter (PM2.5) in a county. Fine particulate matter is defined as particles of air pollutants with an aerodynamic diameter less than 2.5 micrometers. These particles can be directly emitted from sources such as forest fires, or they can form when gases emitted from power plants, industries and automobiles react in the air."
            },
            "mhprate": {
                "label": "MHP Rate",
                "type": "number",
                "format": ",.0f",
                "title": "Mental health providers",
                "url": "http://www.countyhealthrankings.org/measure/mental-health-providers",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Mental Health Providers is the ratio of the county population to the number of mental health providers including psychiatrists, psychologists, licensed clinical social workers, counselors, marriage and family therapists, mental health providers that treat alcohol and other drug abuse, and advanced practice nurses specializing in mental health care. In 2015, marriage and family therapists and mental health providers that treat alcohol and other drug abuse were added to this measure."
            },
            "unemployment": {
                "label": "% Unemployment",
                "type": "percentage",
                "format": ".1%",
                "title": "Unemployment rate",
                "url": "https://www.bls.gov/lau/laucnty16.txt",
                "source": "Bureau of Labor Statistics",
                "description": "Taken from the Local Area Unemployment Statistics (LAUS) program, the Unemployment Rate is a monthly estimate of total employment and unemployment for approximately 7,500 areas, including county and county equivalents."
            },
            "uninsured": {
                "label": "% Uninsured",
                "type": "percentage",
                "format": ".1%",
                "title": "Uninsured",
                "url": "http://www.countyhealthrankings.org/measure/uninsured",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Uninsured is the percentage of the population under age 65 that has no health insurance coverage. The Small Area Health Insurance Estimates uses the American Community Survey (ACS) definition of insured"
            },
            "smokers": {
                "label": "% Smokers",
                "type": "percentage",
                "format": ".1%",
                "title": "Adult smoking",
                "url": "http://www.countyhealthrankings.org/measure/adult-smoking",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Adult Smoking is the percentage of the adult population that currently smokes every day or most days and has smoked at least 100 cigarettes in their lifetime."
            },
            "singleparent": {
                "label": "% Single-Parent Households",
                "type": "percentage",
                "format": ".0%",
                "title": "Children in single-parent households",
                "url": "http://www.countyhealthrankings.org/measure/children-single-parent-households",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Children in Single-Parent Households is the percentage of children in family households where the household is headed by a single parent (male or female head of household with no spouse present)."
            },
            "fairpoor": {
                "label": "% Fair Poor",
                "type": "percentage",
                "format": ".1%",
                "title": "Poor or fair health",
                "url": "http://www.countyhealthrankings.org/measure/poor-or-fair-health",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Self-reported health status is a general measure of health-related quality of life (HRQoL) in a population. This measure is based on survey responses to the question: “In general, would you say that your health is excellent, very good, good, fair, or poor?” The value reported in the County Health Rankings is the percentage of adult respondents who rate their health “fair” or “poor.” The measure is modeled and age-adjusted to the 2000 US population."
            },
            "violentcrime": {
                "label": "Violent Crime Rate",
                "type": "number",
                "format": ",.0f",
                "title": "Violent crime rate",
                "url": "http://www.countyhealthrankings.org/measure/violent-crime-rate",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Violent Crime is the number of violent crimes reported per 100,000 population. Violent crimes are defined as offenses that involve face-to-face confrontation between the victim and the perpetrator, including homicide, rape, robbery, and aggravated assault."
            },
            "income": {
                "label": "Income Ratio",
                "type": "number",
                "format": ",.0f",
                "title": "Income inequality",
                "url": "http://www.countyhealthrankings.org/measure/income-inequality",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Income Inequality is the ratio of household income at the 80th percentile to that at the 20th percentile, i.e., when the incomes of all households in a county are listed from highest to lowest, the 80th percentile is the level of income at which only 20% of households have higher incomes, and the 20th percentile is the level of income at which only 20% of households have lower incomes. A higher inequality ratio indicates greater division between the top and bottom ends of the income spectrum."
            },
            "somecollege": {
                "label": "% Some College",
                "type": "percentage",
                "format": ".1%",
                "title": "Some college",
                "url": "http://www.countyhealthrankings.org/measure/some-college",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Some College is the percentage of the population ages 25-44 with some post-secondary education, such as enrollment in vocational/technical schools, junior colleges, or four-year colleges. It includes individuals who pursued education following high school but did not receive a degree."
            },
            "mentalhealth": {
                "label": "Mentally Unhealthy Days",
                "type": "number",
                "format": ",.1f",
                "title": "Poor mental health days",
                "url": "http://www.countyhealthrankings.org/measure/poor-mental-health-dayss",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Poor Mental Health Days is based on survey responses to the question: “Thinking about your mental health, which includes stress, depression, and problems with emotions, for how many days during the past 30 days was your mental health not good?” The value reported in the County Health Rankings is the average number of days a county’s adult respondents report that their mental health was not good. The measure is age-adjusted to the 2000 US population."
            },
            "physicalhealth": {
                "label": "Physically Unhealthy Days",
                "type": "number",
                "format": ",.1f",
                "title": "Poor physical health days",
                "url": "http://www.countyhealthrankings.org/measure/poor-physical-health-days",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Poor Physical Health Days is based on survey responses to the question: “Thinking about your physical health, which includes physical illness and injury, for how many days during the past 30 days was your physical health not good?” The value reported in the County Health Rankings is the average number of days a county’s adult respondents report that their physical health was not good. The measure is age-adjusted to the 2000 US population."
            },
            "inactive": {
                "label": "% Physically Inactive",
                "type": "percentage",
                "format": ".1%",
                "title": "Physical inactivity",
                "url": "http://www.countyhealthrankings.org/measure/physical-inactivity",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Physical Inactivity is the percentage of adults age 20 and over reporting no leisure-time physical activity. Examples of physical activities provided include running, calisthenics, golf, gardening, or walking for exercise."
            },
            "commute": {
                "label": "% Long Commute/Drives Alone",
                "type": "percentage",
                "format": ".1%",
                "title": "Long Commute-Driving Alone",
                "url": "http://www.countyhealthrankings.org/measure/long-commute-driving-alone",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Long Commute - Driving Alone is the percentage of commuters, among those who commute to work by car, truck, or van alone, who drive longer than 30 minutes to work each day."
            },
            "obese": {
                "label": "% Obese",
                "type": "percentage",
                "format": ".1%",
                "title": "Obesity rate",
                "url": "http://www.countyhealthrankings.org/measure/poor-physical-health-days",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Adult Obesity is the percentage of the adult population (age 20 and older) that reports a body mass index (BMI) greater than or equal to 30 kg/m2."
            },
            "foodenvironment": {
                "label": "Food Environment Index",
                "type": "number",
                "format": ",.0f",
                "title": "Food environment index",
                "url": "http://www.countyhealthrankings.org/measure/poor-physical-health-days",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "The Food Environment Index ranges from 0 (best) to 10 (worst) and equally weights two indicators of the food environment:\n1) Limited access to healthy foods estimates the percentage of the population that is low income and does not live close to a grocery store. Living close to a grocery store is defined differently in rural and nonrural areas; in rural areas, it means living less than 10 miles from a grocery store whereas in nonrural areas, it means less than 1 mile. Low income is defined as having an annual family income of less than or equal to 200 percent of the federal poverty threshold for the family size.\n2) Food insecurity estimates the percentage of the population who did not have access to a reliable source of food during the past year. A two-stage fixed effects model was created using information from the Community Population Survey, Bureau of Labor Statistics, and American Community Survey."
            },
            "dentist": {
                "label": "Dentist Rate",
                "type": "number",
                "format": ",.0f",
                "title": "Dentist",
                "url": "http://www.countyhealthrankings.org/measure/food-environment-index",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Dentists are measured as the ratio of the county population to total dentists in the county."
            },
            "association": {
                "label": "Association Rate",
                "type": "number",
                "format": ",.1f",
                "title": "Social association",
                "url": "http://www.countyhealthrankings.org/measure/social-associations",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Social Associations is the number of associations per 10,000 population. Associations include membership organizations such as civic organizations, bowling centers, golf clubs, fitness centers, sports organizations, religious organizations, political organizations, labor organizations, business organizations, and professional organizations."
            },
            "teenbirth": {
                "label": "Teen Birth Rate",
                "type": "number",
                "format": ",.1f",
                "title": "Teen births",
                "url": "http://www.countyhealthrankings.org/measure/teen-births",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Teen Births are the number of births per 1,000 female population, ages 15-19."
            },
            "excessdrink": {
                "label": "% Excessive Drinking",
                "type": "percentage",
                "format": ".1%",
                "title": "Excessive drinking",
                "url": "http://www.countyhealthrankings.org/measure/excessive-drinking",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Excessive Drinking is the percentage of adults that report either binge drinking, defined as consuming more than 4 (women) or 5 (men) alcoholic beverages on a single occasion in the past 30 days, or heavy drinking, defined as drinking more than one (women) or 2 (men) drinks per day on average."
            },
            "housingproblems": {
                "label": "% Severe Housing Problems",
                "type": "percentage",
                "format": ".1%",
                "title": "Severe housing problems",
                "url": "http://www.countyhealthrankings.org/measure/severe-housing-problems",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Severe Housing Problems is the percentage of households with at least one or more of the following housing problems:\nhousing unit lacks complete kitchen facilities;\nhousing unit lacks complete plumbing facilities;\nhousehold is severely overcrowded; or\nhousehold is severely cost burdened.\nSevere overcrowding is defined as more than 1.5 persons per room. Severe cost burden is defined as monthly housing costs (including utilities) that exceed 50% of monthly income."
            },
            "providers": {
                "label": "Providers",
                "type": "number",
                "format": ",.0f",
                "title": "Number of ACA Proviers",
                "url": "http://www.rwjf.org/en/library/research/2017/04/hix-compare-2014-2017-datasets.html",
                "source": "Robert Wood Johnson Foundation",
                "description": "HIX Compare includes information on premiums, deductibles and out-of-pocket maximums, as well as cost-sharing requirements for primary care and specialist visits, prescription drugs, emergency room services and inpatient and outpatient visits for all plans across all 50 states and the District of Columbia."
            },
            "diabetes": {
                "label": "% Receiving HbA1c",
                "type": "percentage",
                "format": ".1%",
                "title": "Diabetes monitoring",
                "url": "http://www.countyhealthrankings.org/measure/diabetes-monitoring",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Diabetes Monitoring is the percentage of diabetic fee-for-service Medicare patients ages 65-75 whose blood sugar control was not monitored in the past year using a test of their glycated hemoglobin (HbA1c) levels. Note: this differs from the original measure that reported the number of patients who had received testing in the last year."
            },
            "chlamydia": {
                "label": "Chlamydia Rate",
                "type": "number",
                "format": ",.0f",
                "title": "Sexually transmitted infection rate",
                "url": "http://www.countyhealthrankings.org/measure/sexually-transmitted-infection-rate",
                "source": "University of Wisconsin Population Health Institute/Robert Wood Johnson Foundation",
                "description": "Sexually Transmitted Infections (STI) are measured as the chlamydia incidence (number of new cases reported) per 100,000 population."
            }
        };

        // spinner loader settings
        const opts = {
            lines: 9, // The number of lines to draw
            length: 9, // The length of each line
            width: 5, // The line thickness
            radius: 14, // The radius of the inner circle
            color: '#c10e19', // #rgb or #rrggbb or array of colors
            speed: 1.9, // Rounds per second
            trail: 40, // Afterglow percentage
            className: 'spinner', // The CSS class to assign to the spinner
        };

        // number formats
        function formatAbbreviation(x) {
            var v = Math.abs(x);
            return (v >= 0.9995e9 ? formatBillion : v >= 0.9995e6 ? formatMillion : formatThousand)(x);
        }

        // local formatting to get billions
        // https://github.com/d3/d3/issues/2241
        let formatNumber = d3.format(".1f"),
            formatBillion = function(x) {
                return formatNumber(x / 1e9) + "B";
            },
            formatMillion = function(x) {
                return formatNumber(x / 1e6) + "M";
            },
            formatThousand = function(x) {
                return formatNumber(x / 1e3) + "k";
            };

        // create spinner
        let target = d3.select("body").node();

        // trigger loader
        let spinner = new Spinner(opts).spin(target);

        // create tooltip
        let tooltip = d3.select("body").append("div").style("position", "absolute").style("z-index", "10").style("visibility", "hidden").attr("class", "tooltip");

        // select element
        let measureSelect = d3.select('#dimensions');

        let margins = {
            right: 60,
            left: 10,
            top: 20,
            bottom: 50
        };

        let width = 960;
        let height = 720;

        let projection = d3.geoAlbersUsa()
            .scale(1285)
            .translate([width / 2, height / 2]);

        let path = d3.geoPath()
            // .projection(projection)
        ;

        let svg = d3.select("svg")
            .attr("width", width)
            .attr("height", height);

        // create options for select element
        var selectEnter = measureSelect.selectAll('option').data(d3.keys(cols).sort()).enter();

        var selectUpdate = selectEnter.append('option');

        selectUpdate.attr('value', function(d) {
            return d;
        }).text(function(d) {
            return cols[d].title;
        }).attr('selected', function(d) {
            if (d == measure) {
                return true;
            }
        });

        // counter for missing counties (usually in Alaska)
        let countMissing = 0;

        function createMap(error, us, data) {

            if (error) throw error;

            // stop spin.js loader
            spinner.stop();

            // parse data
            let countyObj = {};
            data.forEach(function(d) {
                d.population = +d['Population'];
                d.pollution = +d['Average Daily PM2.5'];
                d.violentcrime = +d['Violent Crime Rate'];
                d.commute = +d['% Long Commute - Drives Alone'];
                d.inactive = +d['% Physically Inactive'];
                d.unemployment = +(d['% unemployment'] * 100).toPrecision(3);
                d.fairpoor = +d['% Fair/Poor'];
                d.smokers = +d['% Smokers'];
                d.singleparent = +d['% Single-Parent Households'];
                d.excessdrink = +d['% Excessive Drinking'];
                d.income = +d['Income Ratio'];
                d.somecollege = +d['% Some College'];
                d.mentalhealth = +d['Mentally Unhealthy Days'];
                d.physicalhealth = +d['Physically Unhealthy Days'];
                d.chlamydia = +d['Chlamydia Rate']; // new cases per 100,000
                d.association = +d['Association Rate']; // number of associations per 10,000 population
                d.uninsured = +d['% Uninsured'];
                d.access = +d['% With Access'];
                d.teenbirth = +d['Teen Birth Rate']; // number of births per 1,000 female population, ages 15-19
                d.housingproblems = +d['% Severe Housing Problems'];
                d.diabetes = 100 - +d['% Receiving HbA1c'];
                d.providers = +d['Providers'];
                d.mhprate = +d['MHP Rate'];
                d.pcprate = +d['PCP Rate'];
                d.dentist = +d['Dentist Rate'];
                d.obese = +d['% Obese'];
                d.foodenvironment = +(10 - +d['Food Environment Index']).toPrecision(3);
                countyObj[d.FIPS] = d;
            });

            let centered;

            // render map colors based on data
            function renderMap() {

                let extent = d3.extent(data, function(d) {
                    return countyObj[d.FIPS][measure];
                });

                color.domain([extent[0], extent[1]]);

                // update legend
                legend
                    .labelFormat(function(d) {
                        let value;
                        
                        if (cols[measure].type == 'percentage') {
                            value = d / 100;
                        }
                        else {
                            value = d;
                        }
                        return d3.format(cols[measure].format)(value);
                    })
                    // .title(cols[measure].label)
                    .scale(color);

                svg.select(".legend")
                    .call(legend);

                countyPathUpdate
                    .transition()
                    .duration(1000)
                    .style("fill", function(d) {
                        let county = countyObj[d.id];
                        if (county)
                            return color(county[measure]);
                        else {
                            countMissing++;
                            console.log(d.id + " Not found" + " errors = " + countMissing);
                            return color(0);
                        }
                    });

            }

            // define mouseover and mouseout events
            function bindHover() {
                document.body.addEventListener('mousemove', function(e) {

                    if (e.target.nodeName == 'path' && e.target.className.animVal !== 'states') {
                        let d = d3.select(e.target).data()[0];
                        let value = cols[measure].type == 'percentage' ? countyObj[d.id][measure] / 100 : countyObj[d.id][measure];
                        let content = countyObj[d.id].County + ', ' + countyObj[d.id].State + '<br>' + 'Voted for: ' + countyObj[d.id].election_result + '<br>' + cols[measure].label + ': ' + d3.format(cols[measure].format)(value);
                        showDetail(e, content);
                    }
                });

                document.body.addEventListener('mouseout', function(e) {
                    if (e.target.nodeName == 'path') hideDetail();
                });
            }

            // define zoom function
            function zoomed() {
                group.attr("transform", d3.event.transform);
                group.select(".nation").style("stroke-width", 0.5 / d3.event.scale + "px");
                group.select(".states").style("stroke-width", 1 / d3.event.scale + "px");
                group.select(".counties").style("stroke-width", 0.1 / d3.event.scale + "px");
            }

            // When clicked, zoom in
            function clicked(d) {
                var x, y, k;

                // Compute centroid of the selected path
                if (d && centered !== d) {
                    // if (d) {
                    var centroid = path.centroid(d);
                    x = centroid[0];
                    y = centroid[1];
                    // k = zoom.scaleExtent()[1];
                    k = 10;
                    centered = d;
                }
                else {
                    x = width / 2;
                    y = height / 2;
                    k = 1;
                    centered = null;
                }

                // Manually Zoom
                svg.transition()
                    .duration(750)
                    .call(zoom.transform, d3.zoomIdentity
                        .translate(width / 2, height / 2)
                        .scale(k)
                        .translate(-x, -y));
            }

            let color = d3.scaleQuantize().range(d3.schemeOranges[9]);

            // create background box for zoom
            svg.append("rect")
                .attr("class", "background")
                .attr("width", width)
                .attr("height", height);

            let zoom = d3.zoom()
                .scaleExtent([1, 15])
                .on("zoom", zoomed);

            svg.style("pointer-events", "all")
                .call(zoom);

            let group = svg.append("g");

            group.append("path")
                .datum(topojson.feature(us, us.objects.nation))
                .attr("class", "nation")
                .attr("d", path)
                .style("stroke-width", "0.5px");

            group.append("path")
                .datum(topojson.mesh(us, us.objects.states, function(a, b) {
                    return a !== b;
                }))
                .attr("class", "states")
                .attr("d", path)
                .style("stroke-width", "1px");

            let countyPathEnter = group.selectAll("path")
                .data(topojson.feature(us, us.objects.counties).features)
                .enter();

            let countyPathUpdate = countyPathEnter
                .append('path')
                .attr("class", "counties")
                .attr("d", path)
                .style("stroke-width", "0.1px")
                .on("click", clicked);

            // create legend
            // use Susie Lu's d3-legend plugin
            // http://d3-legend.susielu.com/
            svg.append("g")
                .attr("class", "legend")
                .attr("transform", "translate(" + (width / 24) + "," + (height * 6 / 7) + ")");

            let legend = d3.legendColor()
                .shapeWidth(width / 10)
                .cells(6)
                .orient("horizontal")
                .labelOffset(3)
                .ascending(true)
                .labelAlign("middle")
                .shapePadding(2);

            renderMap();
            renderText();
            bindHover();
            setResponsiveSVG();

            measureSelect.on('change', function(d) {
                measure = this.value;
                renderMap();
                renderText();
            });

        }

        // change factor description
        function renderText() {

            let textHeader = d3.select('#textDescription h3');
            let textDescription = d3.select('#textDescription p');
            let textFootnote = d3.select('#source > footnote');

            let title = cols[measure].title;
            let description = cols[measure].description;
            let url = cols[measure].url;
            let source = cols[measure].source;

            textHeader.style("opacity", 0).transition().duration(1000).style("opacity", 1).text(title);
            textDescription.style("opacity", 0).transition().duration(1000).style("opacity", 1).text(description);
            textFootnote.html('<em>Source: </em><span><a href="' + url + '" target="_blank">' + source + '</span></a>');

        }

        // Show tooltip on hover
        function showDetail(event, content) {

            // show tooltip with information from the __data__ property of the element
            let x_hover = 0;
            let y_hover = 0;

            let tooltipWidth = parseInt(tooltip.style('width'));
            let tooltipHeight = parseInt(tooltip.style('height'));
            let classed, notClassed;

            if (event.pageX > document.body.clientWidth / 2) {
                x_hover = tooltipWidth + 30;
                classed = 'right';
                notClassed = 'left';
            }
            else {
                x_hover = -30;
                classed = 'left';
                notClassed = 'right';
            }

            y_hover = (document.body.clientHeight - event.pageY < (tooltipHeight + 4)) ? event.pageY - (tooltipHeight + 4) : event.pageY - tooltipHeight / 2;

            return tooltip
                .classed(classed, true)
                .classed(notClassed, false)
                .style("visibility", "visible")
                .style("top", y_hover + "px")
                .style("left", (event.pageX - x_hover) + "px")
                .html(content);
        }

        // Hide tooltip on hover
        function hideDetail() {

            // hide tooltip
            return tooltip.style("visibility", "hidden");
        }

        // Many browsers -- IE particularly -- will not auto-size inline SVG
        // IE applies default width and height sizing
        // padding-bottom hack on a container solves IE inconsistencies in size
        // https://css-tricks.com/scale-svg/#article-header-id-10
        function setResponsiveSVG() {
            let width = +d3.select('svg').attr('width');
            let height = +d3.select('svg').attr('height');
            let calcString = +(height / width) * 100 + "%";

            let svgElement = d3.select('svg');
            let svgParent = d3.select(d3.select('svg').node().parentNode);

            svgElement
                .attr('class', 'scaling-svg')
                .attr('preserveAspectRatio', 'xMinYMin')
                .attr('viewBox', '0 0 ' + width + ' ' + height)
                .attr('width', null)
                .attr('height', null);

            svgParent.style('padding-bottom', calcString);
        }

        d3.queue()
            .defer(d3.json, "https://unpkg.com/us-atlas@1/us/10m.json")
            .defer(d3.csv, "https://raw.githubusercontent.com/tonmcg/us-presidential-election-results/master/public/data/chr.csv")
            .await(createMap);
    </script>
</body>

</html>
